{{- /* Persistent autogenerated secret for infoservice CSRF & SECRET_KEY. */ -}}
{{- $name := printf "infoservice-auto-secret" -}}
{{- $existing := (lookup "v1" "Secret" .Release.Namespace $name) -}}
{{- $length := .Values.infoservice.csrfSecretLength | default 32 -}}
{{- if not $existing }}
{{- $csrf := randAlphaNum $length -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $name }}
  labels:
    app.kubernetes.io/name: infoservice
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: security
    app.kubernetes.io/part-of: cave-stack
  annotations:
    caveconnectome.io/secret-description: "Autogenerated CSRF & SECRET keys for infoservice"
    caveconnectome.io/rotation: "manual"
    # To rotate: delete this secret and re-run helm upgrade.
    # helm upgrade will recreate with a new random value.
 type: Opaque
stringData:
  INFOSERVICE_CSRF_SECRET_KEY: "{{ $csrf }}"
  INFOSERVICE_SECRET_KEY: "b{{ $csrf }}"
{{- else }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $name }}
  labels:
    app.kubernetes.io/name: infoservice
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: security
    app.kubernetes.io/part-of: cave-stack
  annotations:
    caveconnectome.io/secret-description: "Autogenerated CSRF & SECRET keys for infoservice (reused)"
    caveconnectome.io/rotation: "manual"
 type: Opaque
data:
  INFOSERVICE_CSRF_SECRET_KEY: {{ index $existing.data "INFOSERVICE_CSRF_SECRET_KEY" }}
  INFOSERVICE_SECRET_KEY: {{ index $existing.data "INFOSERVICE_SECRET_KEY" }}
{{- end }}
